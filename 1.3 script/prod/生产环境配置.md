# Kubernetes ç”Ÿäº§ç¯å¢ƒé…ç½®æŒ‡å—

## ğŸ‰ å®‰è£…æˆåŠŸç¡®è®¤

æ‚¨çš„Kuberneteså•èŠ‚ç‚¹é›†ç¾¤å·²ç»æˆåŠŸéƒ¨ç½²ï¼ä»¥ä¸‹æ˜¯éªŒè¯ç»“æœï¼š

- âœ… **é›†ç¾¤çŠ¶æ€**: å¥åº·è¿è¡Œ
- âœ… **ç³»ç»Ÿç»„ä»¶**: å…¨éƒ¨æ­£å¸¸ (API Server, etcd, Controller Manager, Scheduler)
- âœ… **ç½‘ç»œæ’ä»¶**: Flannelæ­£å¸¸è¿è¡Œ
- âœ… **å®¹å™¨è¿è¡Œæ—¶**: containerd 1.6.32
- âœ… **Kubernetesç‰ˆæœ¬**: v1.28.2
- âœ… **æƒé™éªŒè¯**: RBACé…ç½®æ­£ç¡®

## ğŸ”§ ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–

### 1. å®‰è£…èµ„æºç›‘æ§

```bash
# å®‰è£…metrics-server
kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml

# éªŒè¯å®‰è£…
kubectl get deployment metrics-server -n kube-system
kubectl top nodes
```

### 2. é…ç½®æŒä¹…åŒ–å­˜å‚¨

```bash
# åˆ›å»ºæœ¬åœ°å­˜å‚¨ç±»
cat <<EOF | kubectl apply -f -
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: local-storage
provisioner: kubernetes.io/no-provisioner
volumeBindingMode: WaitForFirstConsumer
EOF
```

### 3. åˆ›å»ºç”Ÿäº§å‘½åç©ºé—´

```bash
# åˆ›å»ºç”Ÿäº§ç¯å¢ƒå‘½åç©ºé—´
kubectl create namespace production
kubectl create namespace staging
kubectl create namespace monitoring

# è®¾ç½®èµ„æºé…é¢
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: ResourceQuota
metadata:
  name: production-quota
  namespace: production
spec:
  hard:
    requests.cpu: "4"
    requests.memory: 8Gi
    limits.cpu: "6"
    limits.memory: 12Gi
    persistentvolumeclaims: "10"
EOF
```

### 4. é…ç½®ç½‘ç»œç­–ç•¥ï¼ˆå¯é€‰ï¼‰

```bash
# åˆ›å»ºé»˜è®¤ç½‘ç»œç­–ç•¥
cat <<EOF | kubectl apply -f -
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: production
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
EOF
```

### 5. å®‰è£…Ingressæ§åˆ¶å™¨

```bash
# å®‰è£…NGINX Ingress Controller
kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.1/deploy/static/provider/baremetal/deploy.yaml

# éªŒè¯å®‰è£…
kubectl get pods -n ingress-nginx
kubectl get svc -n ingress-nginx
```

## ğŸ›¡ï¸ å®‰å…¨åŠ å›º

### 1. API Serverå®‰å…¨

```bash
# æŸ¥çœ‹å½“å‰API Serveré…ç½®
kubectl cluster-info

# é™åˆ¶åŒ¿åè®¿é—®ï¼ˆå·²é»˜è®¤é…ç½®ï¼‰
grep -r "anonymous" /etc/kubernetes/manifests/
```

### 2. RBACæœ€ä½³å®è·µ

```bash
# åˆ›å»ºåªè¯»ç”¨æˆ·
kubectl create serviceaccount readonly-user
kubectl create clusterrolebinding readonly-binding \
  --clusterrole=view \
  --serviceaccount=default:readonly-user
```

### 3. Podå®‰å…¨ç­–ç•¥

```bash
# åˆ›å»ºPodå®‰å…¨æ ‡å‡†
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Namespace
metadata:
  name: secure-namespace
  labels:
    pod-security.kubernetes.io/enforce: restricted
    pod-security.kubernetes.io/audit: restricted
    pod-security.kubernetes.io/warn: restricted
EOF
```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### 1. å®‰è£…Prometheusç›‘æ§ï¼ˆå¯é€‰ï¼‰

```bash
# ä½¿ç”¨Helmå®‰è£…Prometheus
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update
helm install prometheus prometheus-community/kube-prometheus-stack \
  --namespace monitoring --create-namespace
```

### 2. æ—¥å¿—æ”¶é›†é…ç½®

```bash
# æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—
journalctl -u kubelet -f
journalctl -u containerd -f

# æŸ¥çœ‹podæ—¥å¿—
kubectl logs -f deployment/your-app -n production
```

## ğŸ”„ å¤‡ä»½ç­–ç•¥

### 1. etcdå¤‡ä»½

```bash
# åˆ›å»ºå¤‡ä»½è„šæœ¬
cat <<'EOF' > /opt/etcd-backup.sh
#!/bin/bash
ETCDCTL_API=3 etcdctl snapshot save \
  --endpoints=https://127.0.0.1:2379 \
  --cacert=/etc/kubernetes/pki/etcd/ca.crt \
  --cert=/etc/kubernetes/pki/etcd/healthcheck-client.crt \
  --key=/etc/kubernetes/pki/etcd/healthcheck-client.key \
  /backup/etcd-snapshot-$(date +%Y%m%d%H%M%S).db

# ä¿ç•™æœ€è¿‘7å¤©çš„å¤‡ä»½
find /backup -name "etcd-snapshot-*.db" -mtime +7 -delete
EOF

chmod +x /opt/etcd-backup.sh
mkdir -p /backup

# æ·»åŠ å®šæ—¶ä»»åŠ¡
echo "0 2 * * * /opt/etcd-backup.sh" | crontab -
```

### 2. é…ç½®å¤‡ä»½

```bash
# å¤‡ä»½Kubernetesé…ç½®
cp -r /etc/kubernetes /backup/kubernetes-config-$(date +%Y%m%d)
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### 1. ç³»ç»Ÿå‚æ•°è°ƒä¼˜

```bash
# ä¼˜åŒ–å†…æ ¸å‚æ•°
cat <<EOF >> /etc/sysctl.conf
# Kubernetesä¼˜åŒ–
fs.file-max = 2097152
fs.inotify.max_user_instances = 8192
fs.inotify.max_user_watches = 524288
kernel.pid_max = 4194304
net.core.somaxconn = 32768
net.ipv4.ip_forward = 1
vm.max_map_count = 262144
EOF

sysctl -p
```

### 2. containerdä¼˜åŒ–

```bash
# ä¼˜åŒ–containerdé…ç½®
# å·²åœ¨å®‰è£…æ—¶é…ç½®systemd cgroupé©±åŠ¨
systemctl status containerd
```

## ğŸ“ ç»´æŠ¤å‘½ä»¤

### æ—¥å¸¸æ£€æŸ¥

```bash
# é›†ç¾¤å¥åº·æ£€æŸ¥
kubectl get nodes
kubectl get pods --all-namespaces
kubectl top nodes
kubectl top pods --all-namespaces

# èµ„æºä½¿ç”¨æƒ…å†µ
kubectl describe node
kubectl get events --sort-by=.metadata.creationTimestamp

# æœåŠ¡çŠ¶æ€
systemctl status kubelet
systemctl status containerd
```

### æ•…éšœæ’æŸ¥

```bash
# æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—
journalctl -u kubelet -n 50
journalctl -u containerd -n 50

# æŸ¥çœ‹Podé—®é¢˜
kubectl describe pod <pod-name>
kubectl logs <pod-name> -f

# ç½‘ç»œé—®é¢˜æ’æŸ¥
kubectl get pods -n kube-system
kubectl describe pod -n kube-flannel
```

## ğŸ¯ åº”ç”¨éƒ¨ç½²ç¤ºä¾‹

### éƒ¨ç½²ç¬¬ä¸€ä¸ªåº”ç”¨

```bash
# åˆ›å»ºéƒ¨ç½²
kubectl create deployment webapp --image=nginx:1.20
kubectl expose deployment webapp --port=80 --type=NodePort

# æŸ¥çœ‹æœåŠ¡
kubectl get services
NODE_PORT=$(kubectl get service webapp -o jsonpath='{.spec.ports[0].nodePort}')
echo "åº”ç”¨è®¿é—®åœ°å€: http://$(hostname -I | awk '{print $1}'):${NODE_PORT}"
```

### ä½¿ç”¨é…ç½®æ–‡ä»¶éƒ¨ç½²

```yaml
# webapp.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webapp
spec:
  replicas: 2
  selector:
    matchLabels:
      app: webapp
  template:
    metadata:
      labels:
        app: webapp
    spec:
      containers:
      - name: webapp
        image: nginx:1.20
        ports:
        - containerPort: 80
        resources:
          requests:
            memory: "64Mi"
            cpu: "250m"
          limits:
            memory: "128Mi"
            cpu: "500m"
---
apiVersion: v1
kind: Service
metadata:
  name: webapp-service
spec:
  selector:
    app: webapp
  ports:
  - port: 80
    targetPort: 80
    nodePort: 30080
  type: NodePort
```

## ğŸ†˜ ç´§æ€¥è”ç³»å’Œæ”¯æŒ

- **é›†ç¾¤ä¿¡æ¯**: `kubectl cluster-info`
- **ç‰ˆæœ¬ä¿¡æ¯**: `kubectl version`
- **èŠ‚ç‚¹ä¿¡æ¯**: `kubectl get nodes -o wide`
- **é…ç½®ä½ç½®**: `/etc/kubernetes/`
- **æ—¥å¿—ä½ç½®**: `journalctl -u kubelet`

---

**æ­å–œï¼æ‚¨çš„Kubernetesç”Ÿäº§ç¯å¢ƒå·²å‡†å¤‡å°±ç»ªï¼** ğŸ‰