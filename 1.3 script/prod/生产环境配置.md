# Kubernetes 生产环境配置指南

## 🎉 安装成功确认

您的Kubernetes单节点集群已经成功部署！以下是验证结果：

- ✅ **集群状态**: 健康运行
- ✅ **系统组件**: 全部正常 (API Server, etcd, Controller Manager, Scheduler)
- ✅ **网络插件**: Flannel正常运行
- ✅ **容器运行时**: containerd 1.6.32
- ✅ **Kubernetes版本**: v1.28.2
- ✅ **权限验证**: RBAC配置正确

## 🔧 生产环境优化

### 1. 安装资源监控

```bash
# 安装metrics-server
kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml

# 验证安装
kubectl get deployment metrics-server -n kube-system
kubectl top nodes
```

### 2. 配置持久化存储

```bash
# 创建本地存储类
cat <<EOF | kubectl apply -f -
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: local-storage
provisioner: kubernetes.io/no-provisioner
volumeBindingMode: WaitForFirstConsumer
EOF
```

### 3. 创建生产命名空间

```bash
# 创建生产环境命名空间
kubectl create namespace production
kubectl create namespace staging
kubectl create namespace monitoring

# 设置资源配额
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: ResourceQuota
metadata:
  name: production-quota
  namespace: production
spec:
  hard:
    requests.cpu: "4"
    requests.memory: 8Gi
    limits.cpu: "6"
    limits.memory: 12Gi
    persistentvolumeclaims: "10"
EOF
```

### 4. 配置网络策略（可选）

```bash
# 创建默认网络策略
cat <<EOF | kubectl apply -f -
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: production
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
EOF
```

### 5. 安装Ingress控制器

```bash
# 安装NGINX Ingress Controller
kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.1/deploy/static/provider/baremetal/deploy.yaml

# 验证安装
kubectl get pods -n ingress-nginx
kubectl get svc -n ingress-nginx
```

## 🛡️ 安全加固

### 1. API Server安全

```bash
# 查看当前API Server配置
kubectl cluster-info

# 限制匿名访问（已默认配置）
grep -r "anonymous" /etc/kubernetes/manifests/
```

### 2. RBAC最佳实践

```bash
# 创建只读用户
kubectl create serviceaccount readonly-user
kubectl create clusterrolebinding readonly-binding \
  --clusterrole=view \
  --serviceaccount=default:readonly-user
```

### 3. Pod安全策略

```bash
# 创建Pod安全标准
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Namespace
metadata:
  name: secure-namespace
  labels:
    pod-security.kubernetes.io/enforce: restricted
    pod-security.kubernetes.io/audit: restricted
    pod-security.kubernetes.io/warn: restricted
EOF
```

## 📊 监控和日志

### 1. 安装Prometheus监控（可选）

```bash
# 使用Helm安装Prometheus
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update
helm install prometheus prometheus-community/kube-prometheus-stack \
  --namespace monitoring --create-namespace
```

### 2. 日志收集配置

```bash
# 查看系统日志
journalctl -u kubelet -f
journalctl -u containerd -f

# 查看pod日志
kubectl logs -f deployment/your-app -n production
```

## 🔄 备份策略

### 1. etcd备份

```bash
# 创建备份脚本
cat <<'EOF' > /opt/etcd-backup.sh
#!/bin/bash
ETCDCTL_API=3 etcdctl snapshot save \
  --endpoints=https://127.0.0.1:2379 \
  --cacert=/etc/kubernetes/pki/etcd/ca.crt \
  --cert=/etc/kubernetes/pki/etcd/healthcheck-client.crt \
  --key=/etc/kubernetes/pki/etcd/healthcheck-client.key \
  /backup/etcd-snapshot-$(date +%Y%m%d%H%M%S).db

# 保留最近7天的备份
find /backup -name "etcd-snapshot-*.db" -mtime +7 -delete
EOF

chmod +x /opt/etcd-backup.sh
mkdir -p /backup

# 添加定时任务
echo "0 2 * * * /opt/etcd-backup.sh" | crontab -
```

### 2. 配置备份

```bash
# 备份Kubernetes配置
cp -r /etc/kubernetes /backup/kubernetes-config-$(date +%Y%m%d)
```

## 🚀 性能优化

### 1. 系统参数调优

```bash
# 优化内核参数
cat <<EOF >> /etc/sysctl.conf
# Kubernetes优化
fs.file-max = 2097152
fs.inotify.max_user_instances = 8192
fs.inotify.max_user_watches = 524288
kernel.pid_max = 4194304
net.core.somaxconn = 32768
net.ipv4.ip_forward = 1
vm.max_map_count = 262144
EOF

sysctl -p
```

### 2. containerd优化

```bash
# 优化containerd配置
# 已在安装时配置systemd cgroup驱动
systemctl status containerd
```

## 📝 维护命令

### 日常检查

```bash
# 集群健康检查
kubectl get nodes
kubectl get pods --all-namespaces
kubectl top nodes
kubectl top pods --all-namespaces

# 资源使用情况
kubectl describe node
kubectl get events --sort-by=.metadata.creationTimestamp

# 服务状态
systemctl status kubelet
systemctl status containerd
```

### 故障排查

```bash
# 查看系统日志
journalctl -u kubelet -n 50
journalctl -u containerd -n 50

# 查看Pod问题
kubectl describe pod <pod-name>
kubectl logs <pod-name> -f

# 网络问题排查
kubectl get pods -n kube-system
kubectl describe pod -n kube-flannel
```

## 🎯 应用部署示例

### 部署第一个应用

```bash
# 创建部署
kubectl create deployment webapp --image=nginx:1.20
kubectl expose deployment webapp --port=80 --type=NodePort

# 查看服务
kubectl get services
NODE_PORT=$(kubectl get service webapp -o jsonpath='{.spec.ports[0].nodePort}')
echo "应用访问地址: http://$(hostname -I | awk '{print $1}'):${NODE_PORT}"
```

### 使用配置文件部署

```yaml
# webapp.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webapp
spec:
  replicas: 2
  selector:
    matchLabels:
      app: webapp
  template:
    metadata:
      labels:
        app: webapp
    spec:
      containers:
      - name: webapp
        image: nginx:1.20
        ports:
        - containerPort: 80
        resources:
          requests:
            memory: "64Mi"
            cpu: "250m"
          limits:
            memory: "128Mi"
            cpu: "500m"
---
apiVersion: v1
kind: Service
metadata:
  name: webapp-service
spec:
  selector:
    app: webapp
  ports:
  - port: 80
    targetPort: 80
    nodePort: 30080
  type: NodePort
```

## 🆘 紧急联系和支持

- **集群信息**: `kubectl cluster-info`
- **版本信息**: `kubectl version`
- **节点信息**: `kubectl get nodes -o wide`
- **配置位置**: `/etc/kubernetes/`
- **日志位置**: `journalctl -u kubelet`

---

**恭喜！您的Kubernetes生产环境已准备就绪！** 🎉